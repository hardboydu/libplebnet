<!--
	$FreeBSD$

	This section contains the contents of the old UPGRADE.TXT
	file.
-->
<sect1 id="upgrading">
  <title>Upgrading &os;</title>

  <para>These instructions describe a procedure for doing a binary
  upgrade from an older version of &os;.</para>

  <warning>
    <para>While the &os; upgrade procedure does its best to
    safeguard against accidental loss of data, it is still more than
    possible to <emphasis>wipe out your entire disk</emphasis> with
    this installation!  Please do not accept the final confirmation
    request unless you have adequately backed up any important data
    files.</para>
  </warning>

  <important>
    <para>These notes assume that you are using the version of
    &man.sysinstall.8; supplied with the version of &os; to which you
    intend to upgrade.  Using a mismatched version of &man.sysinstall.8; is
    almost guaranteed to cause problems and has been known to leave
    systems in an unusable state.  The most commonly made mistake in
    this regard is the use of an old copy of &man.sysinstall.8; from
    an existing installation to upgrade to a newer version of
    &os;.  This is <emphasis>not</emphasis> recommended.</para>

    <para>Furthermore, if you are upgrading from &os; 2.2.5 or
    earlier, see <xref linkend="fstab"> for important details regarding changes
    to the <filename>/etc/fstab</filename> file required during the upgrade procedure.</para>
  </important>
  
  <sect2>
    <title>Introduction</title>

    <para>The upgrade procedure replaces distributions selected by the
    user with those corresponding to the new &os; release.  It
    preserves standard system configuration data, as well as user
    data, installed packages and other software.</para>

    <para>Administrators contemplating an upgrade are encouraged to
    study this section in its entirety before commencing an upgrade.
    Failure to do so may result in a failed upgrade or loss of data.</para>

    <sect3>
      <title>Upgrade Overview</title>

      <para>Upgrading of a distribution is performed by extracting the
      new version of the component over the top of the previous
      version.  Files belonging to the old distribution are not
      deleted.</para>

      <para>System configuration is preserved by retaining and
      restoring the previous version of the following files:</para>

      <para><filename>Xaccel.ini</filename>,
<filename>adduser.conf</filename>,
<filename>aliases</filename>,
<filename>aliases.db</filename>,
<filename>amd.map</filename>,
<filename>crontab</filename>,
<filename>csh.cshrc</filename>,
<filename>csh.login</filename>,
<filename>csh.logout</filename>,
<filename>daily</filename>,
<filename>disktab</filename>,
<filename>dm.conf</filename>,
<filename>exports</filename>,
<filename>fbtab</filename>,
<filename>fstab</filename>,
<filename>ftpusers</filename>,
<filename>gettytab</filename>,
<filename>gnats</filename>,
<filename>group</filename>,
<filename>hosts</filename>,
<filename>hosts.equiv</filename>,
<filename>hosts.lpd</filename>,
<filename>inetd.conf</filename>,
<filename>kerberosIV</filename>,
<filename>localtime</filename>,
<filename>login.access</filename>,
<filename>mail.rc</filename>,
<filename>make.conf</filename>,
<filename>manpath.config</filename>,
<filename>master.passwd</filename>,
<filename>mib.txt</filename>,
<filename>modems</filename>,
<filename>monthly</filename>,
<filename>motd</filename>,
<filename>namedb</filename>,
<filename>networks</filename>,
<filename>nsswitch.conf</filename>,
<filename>passwd</filename>,
<filename>phones</filename>,
<filename>ppp</filename>,
<filename>printcap</filename>,
<filename>profile</filename>,
<filename>protocols</filename>,
<filename>pwd.db</filename>,
<filename>rc</filename>,
<filename>rc.firewall</filename>,
<filename>rc.i386</filename>,
<filename>rc.local</filename>,
<filename>rc.network</filename>,
<filename>rc.conf</filename>,
<filename>remote</filename>,
<filename>resolv.conf</filename>,
<filename>rmt</filename>,
<filename>security</filename>,
<filename>sendmail.cf</filename>,
<filename>services</filename>,
<filename>shells</filename>,
<filename>skeykeys</filename>,
<filename>spwd.db</filename>,
<filename>supfile,</filename>
<filename>syslog.conf</filename>,
<filename>termcap</filename>,
<filename>ttys</filename>,
<filename>uucp</filename>,
<filename>weekly</filename></para>

      <para>The versions of these files which correspond to the new
      version are moved to <filename>/etc/upgrade/</filename>.  The
      system administrator may peruse these new versions and merge
      components as desired.  Note that many of these files are
      interdependent, and the best merge procedure is to copy all
      site-specific data from the current files into the new.</para>

      <para>During the upgrade procedure, the administrator is
      prompted for a location into which all files from
      <filename>/etc/</filename> are saved.  In the event that local
      modifications have been made to other files, they may be
      subsequently retrieved from this location.</para>

    </sect3>
  </sect2>

  <sect2>
    <title>Procedure</title>

    <para>This section details the upgrade procedure.  Particular
    attention is given to items which substantially differ from a
    normal installation.</para>

    <sect3>
      <title>Backup</title>

      <para>User data and system configuration should be backed up
      before upgrading.  While the upgrade procedure does its best
      to prevent accidental mistakes, it is possible to partially or
      completely destroy data and configuration information.</para>
    </sect3>

    <sect3>
      <title>Mount Filesystems</title>

      <para>The disklabel editor is entered with the nominated disk's
      filesystem devices listed.  Prior to commencing the upgrade, the
      administrator should make a note of the device names and
      corresponding mountpoints.  These mountpoints should be entered
      here.  <emphasis>Do not</emphasis>set the <quote>newfs
      flag</quote> for any filesystems, as this will cause data
      loss.</para>
    </sect3>

    <sect3>
      <title>Select Distributions</title>

      <para>When selecting distributions, there are no constraints
      on which must be selected.  As a general rule, the <literal>bin</literal>
      distribution should be selected for an update, and the <literal>man</literal>
      distribution if manpages are already installed.  Other
      distributions may be selected beyond those originally
      installed if the administrator wishes to add additional
      functionality.</para>
    </sect3>

    <sect3 id="fstab">
      <title>After Installation</title>

      <para>Once the installation procedure has completed, the
      administrator is prompted to examine the new configuration
      files.  At this point, checks should be made to ensure that the
      system configuration is valid.  In particular, the
      <filename>/etc/rc.conf</filename> and
      <filename>/etc/fstab</filename> files should be checked.</para>

      <para>Read the following, but <emphasis>do not</emphasis> update
      <filename>/etc/fstab</filename> as described below until the new
      system has booted correctly.  The upgrade procedure replaces the
      previous &os; kernel with a <filename>GENERIC</filename> kernel,
      and a custom kernel may need to be generated to suit the local
      system configuration.</para>

      <important>
	<para>&os; 2.2.6 introduced a change in the naming of the
	device from which the root filesystem is mounted.  This
	change affects all systems, however user intervention is
	only required for systems undergoing an upgrade installation
	from a version prior to &os; 2.2.6.</para>

	<para>Previously, the root filesystem was always mounted from
	the compatibility slice, while other partitions on the same
	disk were mounted from their true slice.  This might, for
	example, have resulted in an <filename>/etc/fstab</filename>
	file like:</para>

<screen># Device      Mountpoint      FStype  Options         Dump    Pass#
/dev/wd0s2b   none            swap    sw              0       0
/dev/wd0a     /               ufs     rw              1       1
/dev/wd0s2f   /local0         ufs     rw              1       1
/dev/wd0s2e   /usr            ufs     rw              1       1</screen>

        <para>For &os; 2.2.6 and later, this format changes so that
        the device for <filename>/</filename> is consistent with
        others.  Also, the driver for the ATA-drives has changed from
        &man.wd.4; to &man.ad.4;, so the new file could look something
        like:</para>

<screen># Device      Mountpoint      FStype  Options         Dump    Pass#
/dev/ad0s2b   none            swap    sw              0       0
/dev/ad0s2a   /               ufs     rw              1       1
/dev/ad0s2f   /local0         ufs     rw              1       1
/dev/ad0s2e   /usr            ufs     rw              1       1</screen>

	<para>If <filename>/etc/fstab</filename> is not updated
	manually in this case, the system will issue a warning message
	whenever <filename>/</filename> is mounted (normally at
	startup) indicating the change that must be made.  In
	addition, trouble may be experienced if the root filesystem is
	not correctly unmounted, whereby the root filesystem will not
	be marked clean at the next reboot.</para>

	<para>This change should be made as soon as the upgraded
	system has been successfully rebooted.</para>
      </important>
    </sect3>
  </sect2>

  <sect2>
    <title>Alternative Upgrade Techniques</title>

    <para>Those interested in an upgrade method that allows more
    flexibility and sophistication should take a look at the
    <quote>Upgrading FreeBSD from source</quote> tutorial found at
    http://www.freebsd.org/docs.html.  This method requires reliable
    network connectivity, extra disk space and spare time, but has
    advantages for networks and other more complex
    installations.</para>
  </sect2>
</sect1>  
